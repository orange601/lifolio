'use client';

import React, { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';

// íƒ€ì… ì •ì˜
interface QuizQuestion {
    id: number;
    question: string;
    options: string[];
    correctAnswer: number;
    explanation: string;
}

interface CategoryInfo {
    name: string;
    icon: string;
    color: string;
}

interface Answer {
    questionId: number;
    selected: number | null;
    correct: number;
    isCorrect: boolean;
}

// ì¹´í…Œê³ ë¦¬ í‚¤ íƒ€ì… ì •ì˜
type CategoryKey = 'general' | 'math' | 'programming' | 'history' | 'science' | 'english' | 'sports' | 'entertainment' | 'random';

// ì¹´í…Œê³ ë¦¬ë³„ í€´ì¦ˆ ë°ì´í„°
const quizDataByCategory: Record<CategoryKey, QuizQuestion[]> = {
    general: [
        {
            id: 1,
            question: "ëŒ€í•œë¯¼êµ­ì˜ ìˆ˜ë„ëŠ” ì–´ë””ì¸ê°€ìš”?",
            options: ["ì„œìš¸", "ë¶€ì‚°", "ëŒ€êµ¬", "ì¸ì²œ"],
            correctAnswer: 0,
            explanation: "ëŒ€í•œë¯¼êµ­ì˜ ìˆ˜ë„ëŠ” ì„œìš¸ì…ë‹ˆë‹¤."
        },
        {
            id: 2,
            question: "ì„¸ê³„ì—ì„œ ê°€ì¥ ë†’ì€ ì‚°ì€?",
            options: ["ì—ë² ë ˆìŠ¤íŠ¸", "K2", "ì¹¸ì²¸ì¤‘ê°€", "ë¡œì²´"],
            correctAnswer: 0,
            explanation: "ì—ë² ë ˆìŠ¤íŠ¸ëŠ” í•´ë°œ 8,848më¡œ ì„¸ê³„ì—ì„œ ê°€ì¥ ë†’ì€ ì‚°ì…ë‹ˆë‹¤."
        }
    ],
    math: [
        {
            id: 1,
            question: "2 + 2 Ã— 3ì˜ ê°’ì€?",
            options: ["8", "12", "10", "6"],
            correctAnswer: 0,
            explanation: "ê³±ì…ˆì„ ë¨¼ì € ê³„ì‚°í•˜ë¯€ë¡œ 2 + 6 = 8ì…ë‹ˆë‹¤."
        },
        {
            id: 2,
            question: "ì›ì˜ ë„“ì´ë¥¼ êµ¬í•˜ëŠ” ê³µì‹ì€?",
            options: ["Ï€rÂ²", "2Ï€r", "Ï€d", "rÂ²"],
            correctAnswer: 0,
            explanation: "ì›ì˜ ë„“ì´ëŠ” Ï€ Ã— ë°˜ì§€ë¦„Â²ì…ë‹ˆë‹¤."
        }
    ],
    programming: [
        {
            id: 1,
            question: "JavaScriptì—ì„œ ë³€ìˆ˜ë¥¼ ì„ ì–¸í•˜ëŠ” í‚¤ì›Œë“œê°€ ì•„ë‹Œ ê²ƒì€?",
            options: ["var", "let", "const", "int"],
            correctAnswer: 3,
            explanation: "JavaScriptì—ì„œëŠ” int í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        },
        {
            id: 2,
            question: "HTMLì—ì„œ ê°€ì¥ í° ì œëª© íƒœê·¸ëŠ”?",
            options: ["h1", "h6", "title", "header"],
            correctAnswer: 0,
            explanation: "h1ì€ HTMLì—ì„œ ê°€ì¥ í° ì œëª© íƒœê·¸ì…ë‹ˆë‹¤."
        }
    ],
    history: [
        {
            id: 1,
            question: "ì¡°ì„ ì™•ì¡°ë¥¼ ê±´êµ­í•œ ì‚¬ëŒì€?",
            options: ["ì´ì„±ê³„", "ì •ë„ì „", "ì´ë°©ì›", "ì„¸ì¢…ëŒ€ì™•"],
            correctAnswer: 0,
            explanation: "ì´ì„±ê³„(íƒœì¡°)ê°€ 1392ë…„ ì¡°ì„ ì„ ê±´êµ­í–ˆìŠµë‹ˆë‹¤."
        }
    ],
    science: [
        {
            id: 1,
            question: "ë¬¼ì˜ í™”í•™ì‹ì€?",
            options: ["H2O", "CO2", "NaCl", "O2"],
            correctAnswer: 0,
            explanation: "ë¬¼ì˜ í™”í•™ì‹ì€ H2Oì…ë‹ˆë‹¤."
        }
    ],
    english: [
        {
            id: 1,
            question: "'ì‚¬ê³¼'ë¥¼ ì˜ì–´ë¡œ í•˜ë©´?",
            options: ["Apple", "Orange", "Banana", "Grape"],
            correctAnswer: 0,
            explanation: "ì‚¬ê³¼ëŠ” ì˜ì–´ë¡œ Appleì…ë‹ˆë‹¤."
        }
    ],
    sports: [
        {
            id: 1,
            question: "ì¶•êµ¬ì—ì„œ í•œ íŒ€ì˜ ì„ ìˆ˜ëŠ” ëª‡ ëª…ì¸ê°€ìš”?",
            options: ["11ëª…", "10ëª…", "9ëª…", "12ëª…"],
            correctAnswer: 0,
            explanation: "ì¶•êµ¬ëŠ” ê³¨í‚¤í¼ í¬í•¨ 11ëª…ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤."
        }
    ],
    entertainment: [
        {
            id: 1,
            question: "ì˜í™” 'ê¸°ìƒì¶©'ì˜ ê°ë…ì€?",
            options: ["ë´‰ì¤€í˜¸", "ë°•ì°¬ìš±", "ê¹€ê¸°ë•", "ì´ì°½ë™"],
            correctAnswer: 0,
            explanation: "ì˜í™” 'ê¸°ìƒì¶©'ì€ ë´‰ì¤€í˜¸ ê°ë…ì˜ ì‘í’ˆì…ë‹ˆë‹¤."
        }
    ],
    random: [
        {
            id: 1,
            question: "ì„¸ê³„ì—ì„œ ê°€ì¥ í° ëŒ€ë¥™ì€?",
            options: ["ì•„ì‹œì•„", "ì•„í”„ë¦¬ì¹´", "ë¶ì•„ë©”ë¦¬ì¹´", "ìœ ëŸ½"],
            correctAnswer: 0,
            explanation: "ì•„ì‹œì•„ëŠ” ì„¸ê³„ì—ì„œ ê°€ì¥ í° ëŒ€ë¥™ì…ë‹ˆë‹¤."
        },
        {
            id: 2,
            question: "Pythonì—ì„œ ë¦¬ìŠ¤íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ì˜¬ë°”ë¥¸ ë°©ë²•ì€?",
            options: ["list = {}", "list = []", "list = ()", "list = <>"],
            correctAnswer: 1,
            explanation: "Pythonì—ì„œ ë¦¬ìŠ¤íŠ¸ëŠ” ëŒ€ê´„í˜¸ []ë¡œ ìƒì„±í•©ë‹ˆë‹¤."
        },
        {
            id: 3,
            question: "1 + 1 = ?",
            options: ["1", "2", "3", "4"],
            correctAnswer: 1,
            explanation: "1 + 1 = 2ì…ë‹ˆë‹¤."
        }
    ]
};

// ì¹´í…Œê³ ë¦¬ ì •ë³´ ë§µ
const categoryMap: Record<CategoryKey, CategoryInfo> = {
    general: { name: "ì¼ë°˜ìƒì‹", icon: "ğŸ§ ", color: "blue" },
    math: { name: "ìˆ˜í•™", icon: "ğŸ”¢", color: "green" },
    programming: { name: "í”„ë¡œê·¸ë˜ë°", icon: "ğŸ’»", color: "purple" },
    history: { name: "ì—­ì‚¬", icon: "ğŸ“š", color: "orange" },
    science: { name: "ê³¼í•™", icon: "ğŸ”¬", color: "cyan" },
    english: { name: "ì˜ì–´", icon: "ğŸ‡ºğŸ‡¸", color: "red" },
    sports: { name: "ìŠ¤í¬ì¸ ", icon: "âš½", color: "emerald" },
    entertainment: { name: "ì˜í™”/ë“œë¼ë§ˆ", icon: "ğŸ¬", color: "pink" },
    random: { name: "ëœë¤ í€´ì¦ˆ", icon: "ğŸ²", color: "indigo" }
};

export default function QuizPlayPage() {
    const router = useRouter();
    const searchParams = useSearchParams();

    const categoryParam = searchParams.get('category') || 'random';
    const difficulty = searchParams.get('difficulty') || 'normal';

    // ì¹´í…Œê³ ë¦¬ í‚¤ê°€ ìœ íš¨í•œì§€ í™•ì¸í•˜ëŠ” íƒ€ì… ê°€ë“œ
    const isValidCategory = (key: string): key is CategoryKey => {
        return key in quizDataByCategory;
    };

    const category: CategoryKey = isValidCategory(categoryParam) ? categoryParam : 'random';

    const [quizData, setQuizData] = useState<QuizQuestion[]>([]);
    const [currentQuestion, setCurrentQuestion] = useState<number>(0);
    const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
    const [showResult, setShowResult] = useState<boolean>(false);
    const [score, setScore] = useState<number>(0);
    const [answers, setAnswers] = useState<Answer[]>([]);
    const [timeLeft, setTimeLeft] = useState<number>(30);
    const [quizCompleted, setQuizCompleted] = useState<boolean>(false);

    // ì¹´í…Œê³ ë¦¬ë³„ í€´ì¦ˆ ë°ì´í„° ë¡œë“œ
    useEffect(() => {
        const data = quizDataByCategory[category];
        setQuizData(data);
    }, [category]);

    // ì¹´í…Œê³ ë¦¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const getCategoryInfo = (): CategoryInfo => {
        return categoryMap[category];
    };

    const categoryInfo = getCategoryInfo();

    // íƒ€ì´ë¨¸ íš¨ê³¼
    useEffect(() => {
        if (timeLeft > 0 && !showResult && !quizCompleted && quizData.length > 0) {
            const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
            return () => clearTimeout(timer);
        } else if (timeLeft === 0 && !showResult) {
            handleNextQuestion();
        }
    }, [timeLeft, showResult, quizCompleted, quizData]);

    // ë‹µì•ˆ ì„ íƒ
    const handleAnswerSelect = (answerIndex: number): void => {
        setSelectedAnswer(answerIndex);
    };

    // ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™
    const handleNextQuestion = (): void => {
        if (quizData.length === 0 || currentQuestion >= quizData.length) return;

        const currentQ = quizData[currentQuestion];
        const isCorrect = selectedAnswer === currentQ.correctAnswer;

        const newAnswer: Answer = {
            questionId: currentQ.id,
            selected: selectedAnswer,
            correct: currentQ.correctAnswer,
            isCorrect
        };

        setAnswers(prevAnswers => [...prevAnswers, newAnswer]);

        if (isCorrect) {
            setScore(score + 1);
        }

        setShowResult(true);
    };

    // ê²°ê³¼ í™•ì¸ í›„ ë‹¤ìŒ ë¬¸ì œ
    const handleContinue = (): void => {
        if (currentQuestion < quizData.length - 1) {
            setCurrentQuestion(currentQuestion + 1);
            setSelectedAnswer(null);
            setShowResult(false);
            setTimeLeft(30);
        } else {
            setQuizCompleted(true);
        }
    };

    // í€´ì¦ˆ ì¬ì‹œì‘
    const handleRestart = (): void => {
        setCurrentQuestion(0);
        setSelectedAnswer(null);
        setShowResult(false);
        setScore(0);
        setAnswers([]);
        setTimeLeft(30);
        setQuizCompleted(false);
    };

    // ì¹´í…Œê³ ë¦¬ ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°
    const handleBackToSelection = (): void => {
        router.push('/quiz/select');
    };

    if (quizData.length === 0) {
        return (
            <div className="min-h-screen bg-gradient-to-b from-blue-50 to-white flex items-center justify-center">
                <div className="text-center">
                    <div className="text-4xl mb-4">â³</div>
                    <p className="text-gray-600">í€´ì¦ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        );
    }

    const progress = ((currentQuestion + 1) / quizData.length) * 100;

    if (quizCompleted) {
        return (
            <div className="min-h-screen bg-gradient-to-b from-blue-50 to-white flex flex-col">
                <div className="flex-1 flex items-center justify-center px-4">
                    <div className="max-w-md w-full bg-white rounded-3xl shadow-xl p-8 text-center">
                        <div className="text-6xl mb-6">{categoryInfo.icon}</div>
                        <h1 className="text-2xl font-bold text-blue-900 mb-2">
                            {categoryInfo.name} í€´ì¦ˆ ì™„ë£Œ!
                        </h1>
                        <div className="text-4xl font-bold text-blue-700 mb-2">
                            {score}/{quizData.length}
                        </div>
                        <p className="text-gray-600 mb-6">
                            ì •ë‹µë¥ : {Math.round((score / quizData.length) * 100)}%
                        </p>

                        <div className="bg-gray-100 rounded-lg p-3 mb-6">
                            <p className="text-sm text-gray-600">
                                ë‚œì´ë„: <span className="font-semibold capitalize">{difficulty}</span>
                            </p>
                        </div>

                        <div className="space-y-3">
                            <button
                                onClick={handleRestart}
                                className="w-full py-4 bg-blue-700 hover:bg-blue-800 text-white rounded-xl font-semibold text-lg transition-colors"
                            >
                                ë‹¤ì‹œ ë„ì „í•˜ê¸°
                            </button>
                            <button
                                onClick={handleBackToSelection}
                                className="w-full py-4 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-semibold text-lg transition-colors"
                            >
                                ë‹¤ë¥¸ í€´ì¦ˆ ì„ íƒ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    if (showResult) {
        const current = quizData[currentQuestion];
        const isCorrect = selectedAnswer === current.correctAnswer;

        return (
            <div className="min-h-screen bg-gradient-to-b from-blue-50 to-white flex flex-col">
                <div className="flex-1 flex items-center justify-center px-4">
                    <div className="max-w-md w-full bg-white rounded-3xl shadow-xl p-8 text-center">
                        <div className="text-6xl mb-6">
                            {isCorrect ? "ğŸ‰" : "ğŸ˜…"}
                        </div>

                        <h2 className={`text-2xl font-bold mb-4 ${isCorrect ? 'text-green-600' : 'text-red-600'}`}>
                            {isCorrect ? "ì •ë‹µì…ë‹ˆë‹¤!" : "í‹€ë ¸ìŠµë‹ˆë‹¤!"}
                        </h2>

                        <div className="bg-gray-50 rounded-xl p-4 mb-6 text-left">
                            <p className="text-sm text-gray-600 mb-2">ì •ë‹µ:</p>
                            <p className="font-semibold text-blue-900">
                                {current.options[current.correctAnswer]}
                            </p>
                        </div>

                        <div className="bg-blue-50 rounded-xl p-4 mb-6">
                            <p className="text-sm text-blue-800">
                                {current.explanation}
                            </p>
                        </div>

                        <button
                            onClick={handleContinue}
                            className="w-full py-4 bg-blue-700 hover:bg-blue-800 text-white rounded-xl font-semibold text-lg transition-colors"
                        >
                            {currentQuestion < quizData.length - 1 ? "ë‹¤ìŒ ë¬¸ì œ" : "ê²°ê³¼ ë³´ê¸°"}
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    const current = quizData[currentQuestion];

    return (
        <div className="min-h-screen bg-gradient-to-b from-blue-50 to-white flex flex-col">
            {/* í—¤ë” */}
            <header className="bg-white shadow-sm border-b border-blue-200 px-4 py-4">
                <div className="max-w-md mx-auto">
                    {/* ì¹´í…Œê³ ë¦¬ ì •ë³´ */}
                    <div className="flex items-center justify-center mb-3">
                        <span className="text-lg mr-2">{categoryInfo.icon}</span>
                        <span className="text-sm font-medium text-gray-700">
                            {categoryInfo.name}
                        </span>
                        {difficulty !== 'normal' && (
                            <span className="ml-2 px-2 py-1 bg-gray-100 rounded text-xs capitalize">
                                {difficulty}
                            </span>
                        )}
                    </div>

                    {/* ì§„í–‰ë¥  ë°” */}
                    <div className="flex items-center justify-between mb-3">
                        <span className="text-sm font-medium text-gray-600">
                            {currentQuestion + 1} / {quizData.length}
                        </span>
                        <span className="text-sm font-medium text-blue-600">
                            â° {timeLeft}ì´ˆ
                        </span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-2">
                        <div
                            className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                            style={{ width: `${progress}%` }}
                        ></div>
                    </div>
                </div>
            </header>

            {/* ë©”ì¸ ì½˜í…ì¸  */}
            <main className="flex-1 flex items-center justify-center px-4 py-8">
                <div className="max-w-md w-full">
                    {/* ë¬¸ì œ ì¹´ë“œ */}
                    <div className="bg-white rounded-3xl shadow-xl p-6 mb-6">
                        <div className="text-center mb-6">
                            <div className="text-4xl mb-4">{categoryInfo.icon}</div>
                            <h2 className="text-lg font-bold text-blue-900 leading-relaxed">
                                {current.question}
                            </h2>
                        </div>

                        {/* ì„ íƒì§€ */}
                        <div className="space-y-3">
                            {current.options.map((option, index) => (
                                <button
                                    key={index}
                                    onClick={() => handleAnswerSelect(index)}
                                    className={`w-full p-4 text-left rounded-xl border-2 transition-all duration-200 ${selectedAnswer === index
                                        ? 'border-blue-500 bg-blue-50 text-blue-900'
                                        : 'border-gray-200 bg-white hover:border-blue-300 hover:bg-blue-50'
                                        }`}
                                >
                                    <div className="flex items-center space-x-3">
                                        <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${selectedAnswer === index
                                            ? 'border-blue-500 bg-blue-500'
                                            : 'border-gray-300'
                                            }`}>
                                            {selectedAnswer === index && (
                                                <div className="w-2 h-2 rounded-full bg-white"></div>
                                            )}
                                        </div>
                                        <span className="font-medium">{option}</span>
                                    </div>
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* ë‹¤ìŒ ë²„íŠ¼ */}
                    <button
                        onClick={handleNextQuestion}
                        disabled={selectedAnswer === null}
                        className={`w-full py-4 rounded-xl font-semibold text-lg transition-all duration-200 ${selectedAnswer !== null
                            ? 'bg-blue-700 hover:bg-blue-800 text-white hover:shadow-lg'
                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                            }`}
                    >
                        {currentQuestion === quizData.length - 1 ? "ê²°ê³¼ í™•ì¸" : "ë‹¤ìŒ ë¬¸ì œ"}
                    </button>

                    {/* í˜„ì¬ ì ìˆ˜ */}
                    <div className="text-center mt-4">
                        <span className="text-sm text-gray-600">
                            í˜„ì¬ ì ìˆ˜: <span className="font-bold text-blue-600">{score}</span>
                        </span>
                    </div>
                </div>
            </main>
        </div>
    );
}